@using POM.Models

@{
    Layout = null;
    WebGrid webGrid = new WebGrid(source: Model);
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Parcelas</title>
    <link rel="stylesheet" type="text/css" href="~/CSS/font-awesome.css">
    <link rel="stylesheet" type="text/css" href="~/CSS/mapas.css">
    <link rel="stylesheet" href="~/CSS/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" src="~/JS/jquery.js"></script>
    <script type="text/javascript" src="~/JS/function.js"></script>
    <script type="text/javascript" src="~/JS/Home.js"></script>
    @Html.DevExpress().GetStyleSheets(
       new StyleSheet { ExtensionSuite = ExtensionSuite.NavigationAndLayout },
       new StyleSheet { ExtensionSuite = ExtensionSuite.Editors },
       new StyleSheet { ExtensionSuite = ExtensionSuite.GridView }
   )
    @Html.DevExpress().GetScripts(
        new Script { ExtensionSuite = ExtensionSuite.NavigationAndLayout },
        new Script { ExtensionSuite = ExtensionSuite.Editors },
        new Script { ExtensionSuite = ExtensionSuite.GridView }
    )
</head>

<body>
    <nav class="w3-sidebar w3-bar-block w3-white w3-card w3-animate-left w3-xxlarge" style="display:none;z-index:2" id="mySidebar">
        <a href="javascript:void(0)" onclick="w3_close()" class="w3-bar-item w3-button w3-display-topright w3-text-teal">
            Close
            <i class="fa fa-remove"></i>
        </a>
        <a href="#" class="w3-bar-item w3-button">Link 1</a>
        <a href="#" class="w3-bar-item w3-button">Link 2</a>
        <a href="#" class="w3-bar-item w3-button">Link 3</a>
        <a href="#" class="w3-bar-item w3-button">Link 4</a>
        <a href="#" class="w3-bar-item w3-button">Link 5</a>
    </nav>

    <!-- Navbar -->
    <div class="w3-top">
        <div class="w3-bar w3-theme-d2 w3-left-align">
            <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-hover-white w3-theme-d2" href="javascript:void(0);" onclick="openNav()"><i class="fa fa-bars"></i></a>
            <a href="/POM/Home" class="w3-bar-item w3-button w3-teal"><i class="fa fa-home w3-margin-right"></i>PlotsOnMaps</a>
            <a href="/POM/Parcelas" class="w3-bar-item w3-button w3-hide-small w3-hover-white">Fincas y Parcelas</a>

            <div class="w3-dropdown-hover w3-hide-small">
                <button class="w3-button">Otros <i class="fa fa-caret-down"></i></button>
                <div class="w3-dropdown-content w3-card-4 w3-bar-block">
                    <a href="/POM/Usuarios" class="w3-bar-item w3-button">Usuarios</a>
                    <a href="/POM/Variedades" class="w3-bar-item w3-button">Variedades</a>
                    <a href="/POM/Articulos" class="w3-bar-item w3-button">Artículos</a>
                    <a href="/POM/Operaciones" class="w3-bar-item w3-button">Operaciones</a>
                </div>
            </div>

            <a href="/POM/Filtrado" class="w3-bar-item w3-button w3-hide-small w3-hover-teal" title="Filtrar Operaciones"><i class="fa fa-search"></i></a>
            <a href="/POM/Login" class="w3-bar-item w3-button w3-hide-small w3-right w3-hover-white">Cerrar Sesión</a>
        </div>

        <!-- Navbar on small screens -->
        <div id="navDemo" class="w3-bar-block w3-theme-d2 w3-hide w3-hide-large w3-hide-medium">
            <a href="/POM/Parcelas" class="w3-bar-item w3-button">Parcelas</a>
            <a href="/POM/Otros" class="w3-bar-item w3-button">Otros</a>
            <a href="/POM/Login" class="w3-bar-item w3-button">Cerrar Sesión</a>
        </div>
    </div>

    <input id="pac-input" class="controls" type="text" placeholder="Buscar en Google Maps" style="visibility:hidden">

    <div id="map"></div>
    <div id="floating-panel">
        <input onclick="removeLine();" type=button value="Eliminar Parcela Dibujada del Mapa" style="background-color: white">
    </div>

    <script type="text/javascript">
        function OnEndCallback(s, e) {
            if (s.cpMessage) {
                alert(s.cpMessage);
                delete s.cpMessage;
            }
        }
    </script>

    @Html.DevExpress().Label(lbl => {
    lbl.Name = "lblDevExpress";
    lbl.Properties.EnableClientSideAPI = true;
    }).GetHtml()

    <label id="lblStandard"></label>

    <div id="formparcelas">
        <div class="tablas">
            <h2> Fincas </h2>
            @Html.Action("GridViewPartialFincas")
        </div>

        <div class="tablas" style="margin-top: -8%;">
            <form id="formcrearfinca" class="login-form" action="/POM/CrearFinca" method="post">
                <h3> Añadir Finca </h3>
                <input class="campo2" id="codigoFinca" name="codigo" type="text" placeholder="Código" />
                <input class="campo2" id="nombreFinca" name="nombre" type="text" placeholder="Nombre" />
                <select id="colorFinca" name="color">
                    <option value="X"> Elige un color </option>
                    <option value="-16776961">AZUL</option>
                    <option value="-16711936">VERDE</option>
                    <option value="-65536">ROJO</option>
                    <option value="-256">AMARILLO</option>
                    <option value="-65281">MAGENTA</option>
                    <option value="-16711681">CYAN</option>
                    <option value="-1">BLANCO</option>
                    <option value="-16777216">NEGRO</option>
                </select>
                <input id="crearFinca" type="button" name="enviar" value="Crear Finca" />
                <script>
                    $(document).ready(function () {
                        $(function () {
                            $('#crearFinca').click(function (event) {

                                var finca = {
                                    codigo: $('#codigoFinca').val(),
                                    nombre: $('#nombreFinca').val(),
                                    color: $('#colorFinca').val()
                                };

                                if (comprobarCrearFinca(finca)) {
                                    $.ajax({
                                        type: "POST",
                                        url: "/POM/CrearFinca",
                                        contentType: "application/json",
                                        data: JSON.stringify(finca),
                                        dataType: "json",
                                        async: false,
                                        cache: false,
                                        traditional: true,
                                        success: function (data) {
                                            /*$("#FincaPL").empty();
                                            var options = '';
                                            for (var i = 0; i < data.length; i++) {
                                                options += '<option value="' + data[i].Value + '">' + data[i].Text + '</option>';
                                            }
                                            $('#FincaPL').append(options);*/
                                            alert("¡Finca creada con éxito!");
                                            document.getElementById('codigoFinca').value = ''
                                            document.getElementById('nombreFinca').value = ''
                                            document.getElementById('colorFinca').value = 'Elige un color'
                                            location.reload();
                                        },
                                        error: function (xhr, status, error) { alert("El código de la Finca ya existe en la base de datos."); }
                                    });
                                }
                            });
                        });
                        function comprobarCrearFinca(finca) {
                            var devolver = false;
                            if (finca.codigo != "") {
                                if (finca.nombre != "") {
                                    if (finca.color != "X") {
                                        devolver = true;
                                    }
                                    else alert("Falta elegir el color de la finca");
                                }
                                else alert("Falta por definir el nombre de la finca");
                            }
                            else alert("Falta por definir el código de la finca.");
                            return devolver;
                        }
                    });
                </script>
            </form>
        </div>

        <div class="tablas" style="margin-top: -8%;">
            <h2> Parcelas </h2>
            @Html.Action("GridViewPartialParcelas")
        </div>
        <div class="tablas" style="margin-top: -8%;">
            <form id="formcrearparcela" class="login-form">
                <h3> Añadir Parcela </h3>
                <input class="campo2" id="codigo" name="codigo" type="text" placeholder="Código" />
                <input class="campo2" id="nombre" name="nombre" type="text" placeholder="Nombre" />
                @Html.DropDownList("VariedadPL", ViewData["Variedades"] as List<SelectListItem>)
                <span id="select_variedad" name="sv" style="visibility: hidden"></span>
                <script>
                    $(document).ready(function () {
                        $("#VariedadPL").change(function () {
                            var n = $('#VariedadPL Option:Selected').text();
                            $("#select_variedad").text(n);
                        })
                    })
                </script>
                @Html.DropDownList("FincaPL", ViewData["Fincas"] as List<SelectListItem>)
                <span id="select_finca" name="sf" style="visibility: hidden"></span>
                <script>
                    $(document).ready(function () {
                        $("#FincaPL").change(function () {
                            var n = $('#FincaPL Option:Selected').text();
                            $("#select_finca").text(n);
                        })
                    })
                </script>

                <input id="output" name="Poly" type="text" hidden="hidden" />
                <input id="crear" type="button" value="Crear Parcela" />
                <script type="text/javascript">
                    $(document).ready(function () {
                        $(function () {
                            $('#crear').click(function (event) {

                                var con = 1;
                                var parcela = {
                                    codigo: $('#codigo').val(),
                                    nombre: $('#nombre').val(),
                                    variedad: $('#VariedadPL').val(),
                                    finca: $('#FincaPL').val(),
                                    coordenadas: $('#output').val()
                                };

                                if (comprobarCrearParcela(parcela)) {
                                    $.ajax({
                                        type: "POST",
                                        url: "/POM/CrearParcela",
                                        contentType: "application/json",
                                        data: JSON.stringify(parcela),
                                        dataType: "json",
                                        async: false,
                                        cache: false,
                                        traditional: true,
                                        success: function (data) {
                                            if (data != "'Success':'false'") {
                                                alert("¡Parcela creada exitósamente!");
                                                document.getElementById('codigo').value = ''
                                                document.getElementById('nombre').value = ''
                                                document.getElementById('VariedadPL').value = 'Selecciona una variedad'
                                                document.getElementById('FincaPL').value = 'Selecciona una finca'
                                                document.getElementById('output').value = ''
                                                location.reload();
                                            }
                                            else alert("Ya existe una parcela con el código escrito.")
                                        },
                                        error: function (xhr, status, error) { alert("Fallo en la operación"); }
                                    });
                                }
                            });
                        });
                        function comprobarCrearParcela(parcela) {
                            var devolver = false;
                            
                            if (parcela.codigo != "") {
                                if (parcela.nombre != "") {
                                    if (parcela.variedad != 0) {
                                        if (parcela.finca != 0) {
                                            if (parcela.coordenadas != "") {
                                                devolver = true;
                                            }
                                            else alert("Falta por definir el trazo de la parcela");
                                        }
                                        else alert("Falta por definir la finca a que pertenece la parcela");
                                    }
                                    else alert("Falta por definir la variedad de la parcela");
                                }
                                else alert("Falta por definir el nombre de la parcela");
                            }
                            else alert("Falta por definir el código de la parcela");
                            return devolver;
                        }
                    });
                </script>
            </form>
        </div>

        <div class="tablas" style="margin-top: -8%;">
            <input class="filtrar" id="aplicarFiltro" type="button" style="margin: auto; padding: initial; align-content:center;" value="Recargar Mapa" />
        </div>

            <script type="text/javascript">
                $(function () {
                    $("body").on("click", "#aplicarFiltro", function () {
                        location.reload();
                    });
                });

            </script>
        </div>



        <footer class="w3-container w3-padding-32 w3-theme-d1 w3-center foot">
            <p> © 2018 PlotsOnMaps - Rubén González Membrilla </p>
        </footer>


        <script>
        var polylines = [];
        var coords = [];
        var polylinesDB = [];

        var drawingControl;
        var map;

        function removeLine() {
            for (i = 0; i < polylines.length; i++) {
                polylines[i].setMap(null);
                for (var j = 0; j < polylines[i].length; j++) {
                    polylines[i].getPath().removeAt(j);
                }
            }

            coords = [];
            polylines = [];

            drawingControl.setOptions({
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYLINE
                    ]
                },
                polylineOptions: {
                    editable: true,
                    draggable: false,
                    geodesic: true
                }
            });

            drawingControl.setMap(map);
        }

        function initMap() {
            var myLat = 37.342427;
            var myLng = -6.946881;
            var center = {
                lat: myLat,
                lng: myLng
            };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: center,
                mapTypeId: 'roadmap',
            });

            var arr = new Array();

            var coordenadasparcelas = @Html.Raw(Json.Encode(ViewBag.Poms));

            polylinesDB = [];

            for (var i in coordenadasparcelas) {
                arr = [];
                for (var j = 0; j < coordenadasparcelas[i].length; j++) {
                    arr.push(new google.maps.LatLng(
                        parseFloat(coordenadasparcelas[i][j].latitud),
                        parseFloat(coordenadasparcelas[i][j].longitud)
                    ));
                }

                polylinesDB.push(new google.maps.Polyline({
                    path: arr,
                    geodesic: true,
                    strokeColor: coordenadasparcelas[i][j-1].colorHex,
                    strokeOpacity: 1.0,
                    strokeWeight: 4,
                    fillColor: coordenadasparcelas[i][j-1].colorHex,
                    fillOpacity: 0.35
                }));

                for (var i in polylinesDB) {
                    polylinesDB[i].setMap(map);
                }
            }

            addDrawingControl(map);
            
            var input = document.getElementById('pac-input');
            var searchBox = new google.maps.places.SearchBox(input);
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            
            map.addListener('bounds_changed', function () {
                searchBox.setBounds(map.getBounds());
            });

            var markers = [];
            searchBox.addListener('places_changed', function () {
                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }
                
                markers.forEach(function (marker) {
                    marker.setMap(null);
                });
                markers = [];
                
                var bounds = new google.maps.LatLngBounds();
                places.forEach(function (place) {
                    if (!place.geometry) {
                        return;
                    }
                    var icon = {
                        url: place.icon,
                        size: new google.maps.Size(71, 71),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(17, 34),
                        scaledSize: new google.maps.Size(25, 25)
                    };
                    
                    markers.push(new google.maps.Marker({
                        map: map,
                        icon: icon,
                        title: place.name,
                        position: place.geometry.location
                    }));

                    if (place.geometry.viewport) {
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });
        }

        function initMap2(data) {
            var myLat = 37.342427;
            var myLng = -6.946881;
            var center = {
                lat: myLat,
                lng: myLng
            };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: center,
                mapTypeId: 'roadmap',
            });

            var arr = new Array();

            var coordenadasparcelas = data;

            polylinesDB = [];

            for (var i in coordenadasparcelas) {
                arr = [];
                for (var j = 0; j < coordenadasparcelas[i].length; j++) {
                    arr.push(new google.maps.LatLng(
                        parseFloat(coordenadasparcelas[i][j].latitud),
                        parseFloat(coordenadasparcelas[i][j].longitud)
                    ));
                }

                polylinesDB.push(new google.maps.Polyline({
                    path: arr,
                    geodesic: true,
                    strokeColor: coordenadasparcelas[i][j-1].colorHex,
                    strokeOpacity: 1.0,
                    strokeWeight: 4,
                    fillColor: coordenadasparcelas[i][j-1].colorHex,
                    fillOpacity: 0.35
                }));

                for (var i in polylinesDB) {
                    polylinesDB[i].setMap(map);
                }
            }

            addDrawingControl(map);
            
            var input = document.getElementById('pac-input');
            var searchBox = new google.maps.places.SearchBox(input);
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            
            map.addListener('bounds_changed', function () {
                searchBox.setBounds(map.getBounds());
            });

            var markers = [];
            searchBox.addListener('places_changed', function () {
                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }
                
                markers.forEach(function (marker) {
                    marker.setMap(null);
                });
                markers = [];
                
                var bounds = new google.maps.LatLngBounds();
                places.forEach(function (place) {
                    if (!place.geometry) {
                        return;
                    }
                    var icon = {
                        url: place.icon,
                        size: new google.maps.Size(71, 71),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(17, 34),
                        scaledSize: new google.maps.Size(25, 25)
                    };
                    
                    markers.push(new google.maps.Marker({
                        map: map,
                        icon: icon,
                        title: place.name,
                        position: place.geometry.location
                    }));

                    if (place.geometry.viewport) {
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });
        }

        function addDrawingControl(map) {

            drawingControl = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYLINE
                    ]
                },
                polylineOptions: {
                    editable: true,
                    draggable: false,
                    geodesic: true
                }
            });

            drawingControl.setMap(map);


            google.maps.event.addListener(drawingControl, 'polylinecomplete', function (polyline) {

                polylines.push(polyline);
                for (var i = 0; i < polylines.length; i++) {
                    for (var j = 0; j < polylines[i].getPath().getLength(); j++) {
                        coords.push(polylines[i].getPath().getAt(j).toUrlValue(6));
                    }
                }
                
                document.getElementById('output').value = coords;
                drawingControl.setOptions({
                    drawingMode: null,
                    drawingControl: true,
                    drawingControlOptions: {
                        position: google.maps.ControlPosition.TOP_CENTER,
                        drawingModes: [

                        ]
                    },
                    polylineOptions: {
                        editable: true,
                        draggable: false,
                        geodesic: true
                    }
                });
            });
        }

        google.maps.event.addDomListener(window, "load", initMap);
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu6Bjk8hJSQLCnzB8XBwZrJd2Zoms86j4&libraries=drawing,geometry,places&callback=initMap" async defer></script>

</body>
</html>